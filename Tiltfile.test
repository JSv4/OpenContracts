# Tiltfile.test for OpenContracts CI/test environment
# Used for running tests in GitHub Actions with Kind

# Configuration
CLUSTER_NAME = 'kind-opencontracts-ci'
REGISTRY_NAME = 'opencontracts-registry'
REGISTRY_PORT = '5005'

# Set environment to test
os.environ['OPENCONTRACTS_ENV'] = 'test'

# Extend update settings for CI environments with long build times
if os.getenv('CI'):
    update_settings(
        suppress_unused_image_warnings=None,
        k8s_upsert_timeout_secs=1800,
        max_parallel_updates=1  # Build one at a time to avoid timeouts
    )

# Load secret extension
load('ext://secret', 'secret_create_generic')

# Create secrets from test env files
# These are committed to the repo for testing purposes
secret_create_generic(
    'django-secrets',
    from_env_file='.envs/.test/.django'
)

secret_create_generic(
    'postgres-secrets',
    from_env_file='.envs/.test/.postgres'
)

# Generate K8s configs from .env files (non-sensitive only)
k8s_yaml(local('python3 tilt-helpers.py django-config', quiet=True))
k8s_yaml(local('python3 tilt-helpers.py postgres-config', quiet=True))

# Frontend configuration (not needed for tests)
k8s_yaml(local('python3 tilt-helpers.py frontend-config', quiet=True))

# Use Kustomize to load all resources with test patches applied
k8s_yaml(kustomize('./k8s/test'))

# PostgreSQL deployment
docker_build(
    'localhost:{}/opencontracts-postgres'.format(REGISTRY_PORT),
    context='.',
    dockerfile='./compose/production/postgres/Dockerfile'
)

# Django deployment with test settings
# In CI, the image is pre-built, so only rebuild if files change
docker_build(
    'localhost:{}/opencontracts-django'.format(REGISTRY_PORT),
    context='.',
    dockerfile='./compose/local/django/Dockerfile',
    build_args={'GITHUB_ACTIONS': 'true'},
    # If the image already exists (from pre-build), Tilt will use it
    pull=False,
    # Only rebuild on file changes
    only=['./opencontractserver', './config', './requirements', './manage.py', './compose']
)

# Configure resources
# Use different port for postgres to avoid conflicts
k8s_resource('postgres', port_forwards='5432:5432')
k8s_resource('redis', port_forwards='6379:6379')
k8s_resource('django',
    port_forwards='8000:8000',
    resource_deps=['postgres', 'redis']
)

# Celery worker deployment
k8s_resource('celeryworker',
    resource_deps=['postgres', 'redis']
)

# Microservices
k8s_resource('docling-parser')
k8s_resource('vector-embedder')

print("âœ… Test environment configured")
print("ðŸ§ª Running in test mode with .envs/.test configuration")
print("ðŸ“Š Coverage reports will be generated")
