<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Open, Extensible Document Analytics Platform"><meta name=author content="John Scrudato IV"><link href=https://hatch.pypa.io/latest/walkthrough/advanced/write-your-own-extractors/ rel=canonical><link href=../data-extract-models/ rel=prev><link href=../configure-annotation-view/ rel=next><link rel=icon href=../../../assets/images/logos/favicon.ico><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.5.27"><title>Write Your Own Llama Index Extractor - OpenContracts</title><link rel=stylesheet href=../../../assets/stylesheets/main.6543a935.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/_mkdocstrings.css><link rel=stylesheet href=../../../assets/css/custom.css><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/tonsky/FiraCode@5.2/distr/fira_code.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href=../../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style><script src=../../../assets/javascripts/glightbox.min.js></script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#write-your-own-agentic-llamaindex-data-extractor class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=OpenContracts class="md-header__button md-logo" aria-label=OpenContracts data-md-component=logo> <img src=../../../assets/images/logos/os_legal_128_inverted.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> OpenContracts </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Write Your Own Llama Index Extractor </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/JSv4/OpenContracts title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> JSv4/OpenContracts </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../key-concepts/ class=md-tabs__link> Walkthrough </a> </li> <li class=md-tabs__item> <a href=../../../configuration/choose-and-configure-docker-stack/ class=md-tabs__link> Configuration </a> </li> <li class=md-tabs__item> <a href=../../../development/environment/ class=md-tabs__link> Development </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=OpenContracts class="md-nav__button md-logo" aria-label=OpenContracts data-md-component=logo> <img src=../../../assets/images/logos/os_legal_128_inverted.png alt=logo> </a> OpenContracts </label> <div class=md-nav__source> <a href=https://github.com/JSv4/OpenContracts title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> JSv4/OpenContracts </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0> <span class=md-ellipsis> Home </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> <li class=md-nav__item> <a href=../../../philosophy/ class=md-nav__link> <span class=md-ellipsis> Philosophy </span> </a> </li> <li class=md-nav__item> <a href=../../../quick-start/ class=md-nav__link> <span class=md-ellipsis> Quick-Start </span> </a> </li> <li class=md-nav__item> <a href=../../../requirements/ class=md-nav__link> <span class=md-ellipsis> System Requirements </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1_5> <label class=md-nav__link for=__nav_1_5 id=__nav_1_5_label tabindex=0> <span class=md-ellipsis> How It Works </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_5_label aria-expanded=false> <label class=md-nav__title for=__nav_1_5> <span class="md-nav__icon md-icon"></span> How It Works </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../architecture/under-the-hood/ class=md-nav__link> <span class=md-ellipsis> Backend - Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../../architecture/asynchronous-processing/ class=md-nav__link> <span class=md-ellipsis> Backend - Asynchronous Processing </span> </a> </li> <li class=md-nav__item> <a href=../../../extract_and_retrieval/intro_to_django_annotation_vector_store/ class=md-nav__link> <span class=md-ellipsis> Backend - LlamaIndex & Django Integration </span> </a> </li> <li class=md-nav__item> <a href=../../../extract_and_retrieval/document_data_extract/ class=md-nav__link> <span class=md-ellipsis> Backend- Datagrid Extract </span> </a> </li> <li class=md-nav__item> <a href=../../../extract_and_retrieval/querying_corpus/ class=md-nav__link> <span class=md-ellipsis> Backend- Question Answering </span> </a> </li> <li class=md-nav__item> <a href=../../../extract_and_retrieval/document_data_extract/ class=md-nav__link> <span class=md-ellipsis> Backend- Datagrid Extract </span> </a> </li> <li class=md-nav__item> <a href=../../../architecture/components/annotator/how-annotations-are-created/ class=md-nav__link> <span class=md-ellipsis> Frontend - Annotation Creation </span> </a> </li> <li class=md-nav__item> <a href=../../../architecture/components/annotator/overview/ class=md-nav__link> <span class=md-ellipsis> Frontend - Annotator Component </span> </a> </li> <li class=md-nav__item> <a href=../pawls-token-format/ class=md-nav__link> <span class=md-ellipsis> PDF Data Format </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../acknowledgements/ class=md-nav__link> <span class=md-ellipsis> Acknowledgements </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Walkthrough </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Walkthrough </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../key-concepts/ class=md-nav__link> <span class=md-ellipsis> Key-Concepts </span> </a> </li> <li class=md-nav__item> <a href=../../step-1-add-documents/ class=md-nav__link> <span class=md-ellipsis> Step 1 - Add Documents </span> </a> </li> <li class=md-nav__item> <a href=../../step-2-create-labelset/ class=md-nav__link> <span class=md-ellipsis> Step 2 - Create Labelset </span> </a> </li> <li class=md-nav__item> <a href=../../step-3-create-a-corpus/ class=md-nav__link> <span class=md-ellipsis> Step 3 - Create Corpus </span> </a> </li> <li class=md-nav__item> <a href=../../step-4-create-text-annotations/ class=md-nav__link> <span class=md-ellipsis> Step 4 - Create Some Annotations </span> </a> </li> <li class=md-nav__item> <a href=../../step-5-create-doc-type-annotations/ class=md-nav__link> <span class=md-ellipsis> Step 5 - Create Some Document Annotations </span> </a> </li> <li class=md-nav__item> <a href=../../step-6-search-and-filter-by-annotations/ class=md-nav__link> <span class=md-ellipsis> Step 6 - Search and Filter By Annotations </span> </a> </li> <li class=md-nav__item> <a href=../../step-7-query-corpus/ class=md-nav__link> <span class=md-ellipsis> Step 7 - Query a Corpus </span> </a> </li> <li class=md-nav__item> <a href=../../step-8-data-extract/ class=md-nav__link> <span class=md-ellipsis> Step 8 - Data Extract </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_10 checked> <label class=md-nav__link for=__nav_2_10 id=__nav_2_10_label tabindex> <span class=md-ellipsis> Advanced </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_10_label aria-expanded=true> <label class=md-nav__title for=__nav_2_10> <span class="md-nav__icon md-icon"></span> Advanced </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../data-extract-models/ class=md-nav__link> <span class=md-ellipsis> Data Extract Models </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Write Your Own Llama Index Extractor </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Write Your Own Llama Index Extractor </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#refresher-on-what-an-open-contracts-data-extractor-does class=md-nav__link> <span class=md-ellipsis> Refresher on What an Open Contracts Data Extractor Does </span> </a> </li> <li class=md-nav__item> <a href=#how-open-contracts-integrates-with-llamaindex class=md-nav__link> <span class=md-ellipsis> How Open Contracts Integrates with LlamaIndex </span> </a> <nav class=md-nav aria-label="How Open Contracts Integrates with LlamaIndex"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#custom-djangoannotationvectorstore class=md-nav__link> <span class=md-ellipsis> Custom DjangoAnnotationVectorStore </span> </a> </li> <li class=md-nav__item> <a href=#task-orchestration class=md-nav__link> <span class=md-ellipsis> Task Orchestration </span> </a> </li> <li class=md-nav__item> <a href=#our-default-data-extract-task-oc_llama_index_doc_query class=md-nav__link> <span class=md-ellipsis> Our Default Data Extract Task - oc_llama_index_doc_query </span> </a> <nav class=md-nav aria-label="Our Default Data Extract Task - oc_llama_index_doc_query"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#step-1-mark-datacell-as-started class=md-nav__link> <span class=md-ellipsis> Step 1 - Mark Datacell as Started </span> </a> </li> <li class=md-nav__item> <a href=#step-2-configure-embeddings-and-llm-settings class=md-nav__link> <span class=md-ellipsis> Step 2 - Configure Embeddings and LLM Settings </span> </a> </li> <li class=md-nav__item> <a href=#step-3-initialize-djangoannotationvectorstore-for-llamaindex class=md-nav__link> <span class=md-ellipsis> Step 3 - Initialize DjangoAnnotationVectorStore for LlamaIndex </span> </a> </li> <li class=md-nav__item> <a href=#step-4-perform-retrieval class=md-nav__link> <span class=md-ellipsis> step 4 - Perform Retrieval </span> </a> </li> <li class=md-nav__item> <a href=#step-5-rerank-results class=md-nav__link> <span class=md-ellipsis> Step 5 - Rerank Results </span> </a> </li> <li class=md-nav__item> <a href=#step-6-process-retrieved-annotations class=md-nav__link> <span class=md-ellipsis> Step 6 - Process Retrieved Annotations </span> </a> </li> <li class=md-nav__item> <a href=#step-7-format-retrieved-text-for-output class=md-nav__link> <span class=md-ellipsis> Step 7 - Format Retrieved Text for Output </span> </a> </li> <li class=md-nav__item> <a href=#step-8-parse-data class=md-nav__link> <span class=md-ellipsis> Step 8 - Parse Data </span> </a> </li> <li class=md-nav__item> <a href=#step-9-save-results class=md-nav__link> <span class=md-ellipsis> Step 9 - Save Results </span> </a> </li> <li class=md-nav__item> <a href=#step-10-exception-handling class=md-nav__link> <span class=md-ellipsis> Step 10 - Exception Handling </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#write-a-custom-llamaindex-extractor class=md-nav__link> <span class=md-ellipsis> Write a Custom LlamaIndex Extractor </span> </a> <nav class=md-nav aria-label="Write a Custom LlamaIndex Extractor"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#step-1-ensure-you-load-datacell class=md-nav__link> <span class=md-ellipsis> Step 1 - Ensure you Load Datacell </span> </a> </li> <li class=md-nav__item> <a href=#step-2-setup-embeddings-model-llm class=md-nav__link> <span class=md-ellipsis> Step 2 - Setup Embeddings Model + LLM </span> </a> </li> <li class=md-nav__item> <a href=#step-3-instantiate-open-contracts-vector-store class=md-nav__link> <span class=md-ellipsis> Step 3 - Instantiate Open Contracts Vector Store </span> </a> </li> <li class=md-nav__item> <a href=#step-4-instantiate-query-engine-wrap-it-as-llm-agent-tool class=md-nav__link> <span class=md-ellipsis> Step 4 - Instantiate Query Engine &amp; Wrap it As LLM Agent Tool </span> </a> </li> <li class=md-nav__item> <a href=#step-5-setup-agent class=md-nav__link> <span class=md-ellipsis> Step 5 - Setup Agent </span> </a> </li> <li class=md-nav__item> <a href=#step-6-decide-how-to-map-column-properties-to-retrieval-process class=md-nav__link> <span class=md-ellipsis> Step 6 - Decide how to Map Column Properties to Retrieval Process </span> </a> </li> <li class=md-nav__item> <a href=#step-7-post-process-and-store-data class=md-nav__link> <span class=md-ellipsis> Step 7 - Post-Process and Store Data </span> </a> </li> <li class=md-nav__item> <a href=#step-8-rebuild-containers-and-look-at-your-frontend class=md-nav__link> <span class=md-ellipsis> Step 8 - Rebuild Containers and Look at Your Frontend </span> </a> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../configure-annotation-view/ class=md-nav__link> <span class=md-ellipsis> Configure How Annotations Are Displayed </span> </a> </li> <li class=md-nav__item> <a href=../run-gremlin-analyzer/ class=md-nav__link> <span class=md-ellipsis> Run a Gremlin Analyzer </span> </a> </li> <li class=md-nav__item> <a href=../fork-a-corpus/ class=md-nav__link> <span class=md-ellipsis> Fork a Corpus </span> </a> </li> <li class=md-nav__item> <a href=../export-import-corpuses/ class=md-nav__link> <span class=md-ellipsis> Import and Export Corpuses </span> </a> </li> <li class=md-nav__item> <a href=../generate-graphql-schema-files/ class=md-nav__link> <span class=md-ellipsis> Generate GraphQL Schema Files </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Configuration </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../configuration/choose-and-configure-docker-stack/ class=md-nav__link> <span class=md-ellipsis> Choose and Configure Docker Compose Stack </span> </a> </li> <li class=md-nav__item> <a href=../../../configuration/configure-admin-users/ class=md-nav__link> <span class=md-ellipsis> Configure Admin Users </span> </a> </li> <li class=md-nav__item> <a href=../../../configuration/choose-an-authentication-backend/ class=md-nav__link> <span class=md-ellipsis> Configure Authentication Backend </span> </a> </li> <li class=md-nav__item> <a href=../../../configuration/add-users/ class=md-nav__link> <span class=md-ellipsis> Add Users </span> </a> </li> <li class=md-nav__item> <a href=../../../configuration/choose-storage-backend/ class=md-nav__link> <span class=md-ellipsis> Configure Storage Backend </span> </a> </li> <li class=md-nav__item> <a href=../../../configuration/configure-gremlin/ class=md-nav__link> <span class=md-ellipsis> Configure Gremlin Analyzer </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../development/environment/ class=md-nav__link> <span class=md-ellipsis> Dev Environment </span> </a> </li> <li class=md-nav__item> <a href=../../../development/test-suite/ class=md-nav__link> <span class=md-ellipsis> Test Suite </span> </a> </li> <li class=md-nav__item> <a href=../../../development/frontend-notes/ class=md-nav__link> <span class=md-ellipsis> Frontend Notes </span> </a> </li> <li class=md-nav__item> <a href=../../../development/documentation/ class=md-nav__link> <span class=md-ellipsis> Documentation </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#refresher-on-what-an-open-contracts-data-extractor-does class=md-nav__link> <span class=md-ellipsis> Refresher on What an Open Contracts Data Extractor Does </span> </a> </li> <li class=md-nav__item> <a href=#how-open-contracts-integrates-with-llamaindex class=md-nav__link> <span class=md-ellipsis> How Open Contracts Integrates with LlamaIndex </span> </a> <nav class=md-nav aria-label="How Open Contracts Integrates with LlamaIndex"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#custom-djangoannotationvectorstore class=md-nav__link> <span class=md-ellipsis> Custom DjangoAnnotationVectorStore </span> </a> </li> <li class=md-nav__item> <a href=#task-orchestration class=md-nav__link> <span class=md-ellipsis> Task Orchestration </span> </a> </li> <li class=md-nav__item> <a href=#our-default-data-extract-task-oc_llama_index_doc_query class=md-nav__link> <span class=md-ellipsis> Our Default Data Extract Task - oc_llama_index_doc_query </span> </a> <nav class=md-nav aria-label="Our Default Data Extract Task - oc_llama_index_doc_query"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#step-1-mark-datacell-as-started class=md-nav__link> <span class=md-ellipsis> Step 1 - Mark Datacell as Started </span> </a> </li> <li class=md-nav__item> <a href=#step-2-configure-embeddings-and-llm-settings class=md-nav__link> <span class=md-ellipsis> Step 2 - Configure Embeddings and LLM Settings </span> </a> </li> <li class=md-nav__item> <a href=#step-3-initialize-djangoannotationvectorstore-for-llamaindex class=md-nav__link> <span class=md-ellipsis> Step 3 - Initialize DjangoAnnotationVectorStore for LlamaIndex </span> </a> </li> <li class=md-nav__item> <a href=#step-4-perform-retrieval class=md-nav__link> <span class=md-ellipsis> step 4 - Perform Retrieval </span> </a> </li> <li class=md-nav__item> <a href=#step-5-rerank-results class=md-nav__link> <span class=md-ellipsis> Step 5 - Rerank Results </span> </a> </li> <li class=md-nav__item> <a href=#step-6-process-retrieved-annotations class=md-nav__link> <span class=md-ellipsis> Step 6 - Process Retrieved Annotations </span> </a> </li> <li class=md-nav__item> <a href=#step-7-format-retrieved-text-for-output class=md-nav__link> <span class=md-ellipsis> Step 7 - Format Retrieved Text for Output </span> </a> </li> <li class=md-nav__item> <a href=#step-8-parse-data class=md-nav__link> <span class=md-ellipsis> Step 8 - Parse Data </span> </a> </li> <li class=md-nav__item> <a href=#step-9-save-results class=md-nav__link> <span class=md-ellipsis> Step 9 - Save Results </span> </a> </li> <li class=md-nav__item> <a href=#step-10-exception-handling class=md-nav__link> <span class=md-ellipsis> Step 10 - Exception Handling </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#write-a-custom-llamaindex-extractor class=md-nav__link> <span class=md-ellipsis> Write a Custom LlamaIndex Extractor </span> </a> <nav class=md-nav aria-label="Write a Custom LlamaIndex Extractor"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#step-1-ensure-you-load-datacell class=md-nav__link> <span class=md-ellipsis> Step 1 - Ensure you Load Datacell </span> </a> </li> <li class=md-nav__item> <a href=#step-2-setup-embeddings-model-llm class=md-nav__link> <span class=md-ellipsis> Step 2 - Setup Embeddings Model + LLM </span> </a> </li> <li class=md-nav__item> <a href=#step-3-instantiate-open-contracts-vector-store class=md-nav__link> <span class=md-ellipsis> Step 3 - Instantiate Open Contracts Vector Store </span> </a> </li> <li class=md-nav__item> <a href=#step-4-instantiate-query-engine-wrap-it-as-llm-agent-tool class=md-nav__link> <span class=md-ellipsis> Step 4 - Instantiate Query Engine &amp; Wrap it As LLM Agent Tool </span> </a> </li> <li class=md-nav__item> <a href=#step-5-setup-agent class=md-nav__link> <span class=md-ellipsis> Step 5 - Setup Agent </span> </a> </li> <li class=md-nav__item> <a href=#step-6-decide-how-to-map-column-properties-to-retrieval-process class=md-nav__link> <span class=md-ellipsis> Step 6 - Decide how to Map Column Properties to Retrieval Process </span> </a> </li> <li class=md-nav__item> <a href=#step-7-post-process-and-store-data class=md-nav__link> <span class=md-ellipsis> Step 7 - Post-Process and Store Data </span> </a> </li> <li class=md-nav__item> <a href=#step-8-rebuild-containers-and-look-at-your-frontend class=md-nav__link> <span class=md-ellipsis> Step 8 - Rebuild Containers and Look at Your Frontend </span> </a> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=write-your-own-agentic-llamaindex-data-extractor>Write Your Own Agentic, LlamaIndex Data Extractor<a class=headerlink href=#write-your-own-agentic-llamaindex-data-extractor title="Permanent link">&para;</a></h1> <h2 id=refresher-on-what-an-open-contracts-data-extractor-does>Refresher on What an Open Contracts Data Extractor Does<a class=headerlink href=#refresher-on-what-an-open-contracts-data-extractor-does title="Permanent link">&para;</a></h2> <p>When you create a new Extract on the frontend, you can build a grid of data field columns and document rows that the application will traverse, cell-by-cell, to answer the question posed in each column for every document:</p> <p><a class=glightbox href=../../../docs/assets/images/screenshots/Datagrid.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=datagrid src=../../../docs/assets/images/screenshots/Datagrid.png></a></p> <p>You can define the target data shape for each column - e.g. require all outputs match a certain dictionary schema or be floats. We leverage LLMs to ensure that the retrieved data matches the desired schema.</p> <p>You'll notice when you add or edit a column, you can configure a number of different things:</p> <p><a class=glightbox href=../../../docs/assets/images/screenshots/Edit_Column.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=datagrid src=../../../docs/assets/images/screenshots/Edit_Column.png></a></p> <p>Specifically, you can adjust - <strong>name</strong>: The name of the column. - <strong>query</strong>: The query used for extraction. - <strong>match_text</strong>: Text we want to match semantically to process on. We use this instead of the query to find responsive text, if this field is provided. If not, we have to fall back to the query. - <strong>must_contain_text</strong>: Text that must be contained in a returned annotation. This is case insensitive. - <strong>output_type</strong>: The type of data to be extracted. This can be a python primitive or a simple Pydantic model. - <strong>instructions</strong>: Instructions for the extraction process. This instructs our parser how to convert retrieved text to the target output_type. Not strictly necessary, but recommended, specifically for objects. - <strong>task_name</strong>: The name of the registered celery extract task to use to process (lets you define and deploy custom ones). We'll show you have to create a custom one in this walkthrough. - <strong>agentic</strong>: Boolean indicating if the extraction is agentic. - <strong>extract_is_list</strong>: Boolean indicating if the extraction result is a list of the <code>output_types</code> you provided.</p> <p>You'll notice that in the GUI, there is a dropdown to pick the extract task:</p> <p><a class=glightbox href=../../../docs/assets/images/screenshots/Extract_Task_Dropdown.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=Extract_Task_Dropdown.png src=../../../docs/assets/images/screenshots/Extract_Task_Dropdown.png></a></p> <p>This is actually retrieved dynamically from the backend from the tasks in <code>opencontractsserver.tasks.data_extract_tasks.py</code>. Every <strong>celery task</strong> in this python module will show up in the GUI, and the description in the dropdown is actually pulled out of the docstring provided in the code itself:</p> <div class=highlight><pre><span></span><code><span class=nd>@shared_task</span>
<span class=k>def</span> <span class=nf>oc_llama_index_doc_query</span><span class=p>(</span><span class=n>cell_id</span><span class=p>,</span> <span class=n>similarity_top_k</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>max_token_length</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>512</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    OpenContracts&#39; default LlamaIndex and Marvin-based data extract pipeline to run queries specified for a</span>
<span class=sd>    particular cell. We use sentence transformer embeddings + sentence transformer re-ranking.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=o>...</span>
</code></pre></div> <p><strong>This means you can write your own data extractors!</strong> If you write a new task in data_extract_tasks.py, the next time the containers are rebuilt, you should see your custom extractor. We'll walk through this in a minute.</p> <h2 id=how-open-contracts-integrates-with-llamaindex>How Open Contracts Integrates with LlamaIndex<a class=headerlink href=#how-open-contracts-integrates-with-llamaindex title="Permanent link">&para;</a></h2> <p>You don't have to use LlamaIndex in your extractor - you could just pass an entire document to OpenAI's GPT-4o, for example, <em>but</em> LlamaIndex provides a tremendous amount of configurability that may yield to faster, better, cheaper or more reliable performance in many cases. You could even incorporate tools and third-party APIs in agentic fashion.</p> <p>We assume you're already familiar wtih <a href=https://github.com/run-llama/llama_index>LlamaIndex</a>, the "data framework for your LLM applications". It has a rich ecosystem of integrations, prompt templates, agents, retrieval techniques and more to let you customize how your LLMs interact with data.</p> <h3 id=custom-djangoannotationvectorstore>Custom DjangoAnnotationVectorStore<a class=headerlink href=#custom-djangoannotationvectorstore title="Permanent link">&para;</a></h3> <p>We've written a custom implementation of one of LlamaIndex's core building blocks - the VectorStore - that lets LlamaIndex use OpenContracts as a vector store. Our <code>DjangoAnnotationVectorStore</code> in <code>opencontractserver/llms/vector_stores.py</code> lets you quickly write a LlamaIndex agent or question answering pipeline that can pull directly from the rich annotations and structural data (like annotation positions, layout class - e.g. header - and more) in OpenContracts. If you want to learn more about LlamaIndex's vector stores, see more in <a href=https://docs.llamaindex.ai/en/stable/module_guides/indexing/vector_store_guide/ >the documentation</a> about VectorStores.</p> <h3 id=task-orchestration>Task Orchestration<a class=headerlink href=#task-orchestration title="Permanent link">&para;</a></h3> <p>As discussed elsewhere, we use celery workers to run most of our analytics and transform logic. It simplifies the management of complex queues and lets us scale our application compute horizontally in the right environment.</p> <p>Our data extract functionality has an orchestrator task - <code>run_extract</code>. For each data extract column for <em>each</em> document in the extract, we look at the column's <code>task_name</code> property and use it to attempt to load the celery task with that name via the <code>get_task_by_name</code> function:</p> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>get_task_by_name</span><span class=p>(</span><span class=n>task_name</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Callable</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Try to get celery task function Callable by name</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>celery_app</span><span class=o>.</span><span class=n>tasks</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>task_name</span><span class=p>)</span>
    <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div> <p>As we loop over the datacells, we store the celery invocation for the cell's column's <code>task_name</code> in a task list: <div class=highlight><pre><span></span><code><span class=k>for</span> <span class=n>document_id</span> <span class=ow>in</span> <span class=n>document_ids</span><span class=p>:</span>
        <span class=k>for</span> <span class=n>column</span> <span class=ow>in</span> <span class=n>fieldset</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>all</span><span class=p>():</span>
            <span class=k>with</span> <span class=n>transaction</span><span class=o>.</span><span class=n>atomic</span><span class=p>():</span>
                <span class=n>cell</span> <span class=o>=</span> <span class=n>Datacell</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
                    <span class=n>extract</span><span class=o>=</span><span class=n>extract</span><span class=p>,</span>
                    <span class=n>column</span><span class=o>=</span><span class=n>column</span><span class=p>,</span>
                    <span class=n>data_definition</span><span class=o>=</span><span class=n>column</span><span class=o>.</span><span class=n>output_type</span><span class=p>,</span>
                    <span class=n>creator_id</span><span class=o>=</span><span class=n>user_id</span><span class=p>,</span>
                    <span class=n>document_id</span><span class=o>=</span><span class=n>document_id</span><span class=p>,</span>
                <span class=p>)</span>

            <span class=c1># Omitting some code here</span>
            <span class=o>...</span>

            <span class=c1># Get the task function dynamically based on the column&#39;s task_name</span>
            <span class=n>task_func</span> <span class=o>=</span> <span class=n>get_task_by_name</span><span class=p>(</span><span class=n>column</span><span class=o>.</span><span class=n>task_name</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>task_func</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span>
                    <span class=sa>f</span><span class=s2>&quot;Task </span><span class=si>{</span><span class=n>column</span><span class=o>.</span><span class=n>task_name</span><span class=si>}</span><span class=s2> not found for column </span><span class=si>{</span><span class=n>column</span><span class=o>.</span><span class=n>id</span><span class=si>}</span><span class=s2>&quot;</span>
                <span class=p>)</span>
                <span class=k>continue</span>

            <span class=c1># Add the task to the group</span>
            <span class=n>tasks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>task_func</span><span class=o>.</span><span class=n>si</span><span class=p>(</span><span class=n>cell</span><span class=o>.</span><span class=n>pk</span><span class=p>))</span>
</code></pre></div></p> <p>Upon completing the traversal of the grid, we use a celery workflow to run all the cell extract tasks in parallel:</p> <div class=highlight><pre><span></span><code>chord(group(*tasks))(mark_extract_complete.si(extract_id))
</code></pre></div> <h3 id=our-default-data-extract-task-oc_llama_index_doc_query>Our Default Data Extract Task - <code>oc_llama_index_doc_query</code><a class=headerlink href=#our-default-data-extract-task-oc_llama_index_doc_query title="Permanent link">&para;</a></h3> <p>Our default data extractor uses LlamaIndex to retrieved and structure the data in the DataGrid. Before we write a new one, let's walk through how we orchestrate tasks and how our default extract works.</p> <p><code>oc_llama_index_doc_query</code> requires a Datacell id as positional argument. <strong>NOTE</strong> if you were to write your own extract task, you'd need to follow this same signature (with a name of your choice, of course):</p> <p><div class=highlight><pre><span></span><code><span class=nd>@shared_task</span>
<span class=k>def</span> <span class=nf>oc_llama_index_doc_query</span><span class=p>(</span><span class=n>cell_id</span><span class=p>,</span> <span class=n>similarity_top_k</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>max_token_length</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>512</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    OpenContracts&#39; default LlamaIndex and Marvin-based data extract pipeline to run queries specified for a</span>
<span class=sd>    particular cell. We use sentence transformer embeddings + sentence transformer re-ranking.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=o>...</span>
</code></pre></div> The frontend pulls the task description from the docstring, so, again, if you write your own, make sure you provide a useful description.</p> <p><strong>Let's walk through how <code>oc_llama_index_doc_query</code> works</strong></p> <h4 id=step-1-mark-datacell-as-started>Step 1 - Mark Datacell as Started<a class=headerlink href=#step-1-mark-datacell-as-started title="Permanent link">&para;</a></h4> <p>Once the task kicks off, step one is to log in the DB that the task has started:</p> <div class=highlight><pre><span></span><code>    <span class=k>try</span><span class=p>:</span>
    <span class=n>datacell</span><span class=o>.</span><span class=n>started</span> <span class=o>=</span> <span class=n>timezone</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
    <span class=n>datacell</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</code></pre></div> <ul> <li><strong>Exception Handling</strong>: We use a <code>try</code> block to handle any exceptions that might occur during the processing.</li> <li><strong>Set Started Timestamp</strong>: We set the <code>started</code> field to the current time to mark the beginning of the datacell processing.</li> <li><strong>Save Changes</strong>: We save the <code>Datacell</code> object to the database.</li> </ul> <h4 id=step-2-configure-embeddings-and-llm-settings>Step 2 - Configure Embeddings and LLM Settings<a class=headerlink href=#step-2-configure-embeddings-and-llm-settings title="Permanent link">&para;</a></h4> <p>Then, we create our embeddings module. We actually have a microservice for this to cut down on memory usage and allow for easier scaling of the compute-intensive parts of the app. For now, though, the task does not call the microservice so we're using a lightweight sentence tranformer embeddings model:</p> <div class=highlight><pre><span></span><code>    <span class=n>document</span> <span class=o>=</span> <span class=n>datacell</span><span class=o>.</span><span class=n>document</span>

    <span class=n>embed_model</span> <span class=o>=</span> <span class=n>HuggingFaceEmbedding</span><span class=p>(</span>
        <span class=n>model_name</span><span class=o>=</span><span class=s2>&quot;multi-qa-MiniLM-L6-cos-v1&quot;</span><span class=p>,</span> <span class=n>cache_folder</span><span class=o>=</span><span class=s2>&quot;/models&quot;</span>
    <span class=p>)</span>
    <span class=n>Settings</span><span class=o>.</span><span class=n>embed_model</span> <span class=o>=</span> <span class=n>embed_model</span>

    <span class=n>llm</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>settings</span><span class=o>.</span><span class=n>OPENAI_MODEL</span><span class=p>,</span> <span class=n>api_key</span><span class=o>=</span><span class=n>settings</span><span class=o>.</span><span class=n>OPENAI_API_KEY</span><span class=p>)</span>
    <span class=n>Settings</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</code></pre></div> <ul> <li><strong>Retrieve Document</strong>: We fetch the document associated with the datacell.</li> <li><strong>Configure Embedding Model</strong>: We set up the HuggingFace embedding model. This model converts text into embeddings ( vector representations) which are essential for semantic search.</li> <li><strong>Set Embedding Model in Settings</strong>: We assign the embedding model to <code>Settings.embed_model</code> for global access within the task.</li> <li><strong>Configure LLM</strong>: We set up the OpenAI model using the API key from settings. This model will be used for language processing tasks.</li> <li><strong>Set LLM in Settings</strong>: We assign the LLM to <code>Settings.llm</code> for global access within the task.</li> </ul> <h4 id=step-3-initialize-djangoannotationvectorstore-for-llamaindex>Step 3 - Initialize DjangoAnnotationVectorStore for LlamaIndex<a class=headerlink href=#step-3-initialize-djangoannotationvectorstore-for-llamaindex title="Permanent link">&para;</a></h4> <p>Now, here's the cool part with LlamaIndex. Assuming we have Django models with embeddings produced by the same embeddings model, we don't need to do any real-time encoding of our source documents, and our Django object store in Postgres can be loaded as a LlamaIndex vector store. Even better, we can pass in some arguments that let us scope the store down to what we want. For example, we can limit retrieving text from to document, to annotations containing certain text, and to annotations with certain labels - e.g. <code>termination</code>. This lets us leverage all of the work that's been done by humans (and machines) in an OpenContracts corpus to label and tag documents. We're getting the best of both worlds - both human and machine intelligence!</p> <div class=highlight><pre><span></span><code>    <span class=n>vector_store</span> <span class=o>=</span> <span class=n>DjangoAnnotationVectorStore</span><span class=o>.</span><span class=n>from_params</span><span class=p>(</span>
        <span class=n>document_id</span><span class=o>=</span><span class=n>document</span><span class=o>.</span><span class=n>id</span><span class=p>,</span> <span class=n>must_have_text</span><span class=o>=</span><span class=n>datacell</span><span class=o>.</span><span class=n>column</span><span class=o>.</span><span class=n>must_contain_text</span>
    <span class=p>)</span>
    <span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_vector_store</span><span class=p>(</span><span class=n>vector_store</span><span class=o>=</span><span class=n>vector_store</span><span class=p>)</span>
</code></pre></div> <ul> <li><strong>Vector Store Initialization</strong>: Here we create an instance of <code>DjangoAnnotationVectorStore</code> using parameters specific to the document and column.</li> <li><strong>LlamaIndex Integration</strong>: We create a <code>VectorStoreIndex</code> from the custom vector store. This integrates the vector store with LlamaIndex, enabling advanced querying capabilities.</li> </ul> <h4 id=step-4-perform-retrieval>step 4 - Perform Retrieval<a class=headerlink href=#step-4-perform-retrieval title="Permanent link">&para;</a></h4> <p>Now we use the properties of a configured column to find the proper text. For example, if match_text has been provided, we search for nearest K annotations to the match_text (rather than searching based on the query itself):</p> <div class=highlight><pre><span></span><code>    <span class=n>search_text</span> <span class=o>=</span> <span class=n>datacell</span><span class=o>.</span><span class=n>column</span><span class=o>.</span><span class=n>match_text</span>
    <span class=n>query</span> <span class=o>=</span> <span class=n>datacell</span><span class=o>.</span><span class=n>column</span><span class=o>.</span><span class=n>query</span>

    <span class=n>retriever</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span><span class=n>similarity_top_k</span><span class=o>=</span><span class=n>similarity_top_k</span><span class=p>)</span>
    <span class=n>results</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>retrieve</span><span class=p>(</span><span class=n>search_text</span> <span class=k>if</span> <span class=n>search_text</span> <span class=k>else</span> <span class=n>query</span><span class=p>)</span>
</code></pre></div> <ul> <li><strong>Retrieve Search Text and Query</strong>: We fetch the search text and query from the column associated with the datacell.</li> <li><strong>Configure Retriever</strong>: We configure the retriever with the <code>similarity_top_k</code> parameter, which determines the number of top similar results to retrieve.</li> <li><strong>Retrieve Results</strong>: We perform the retrieval using the search text or query. The retriever fetches the most relevant annotations from the vector store.</li> </ul> <h4 id=step-5-rerank-results>Step 5 - Rerank Results<a class=headerlink href=#step-5-rerank-results title="Permanent link">&para;</a></h4> <p>We use a LlamaIndex reranker (in this case a SentenceTransformer reranker) to rerank the retrieved annotations based on the query (this is an example of where you could easily customize your own pipeline - you might want to rerank based on match text, use an LLM-based reranker, or use a totally different reranker like cohere):</p> <div class=highlight><pre><span></span><code><span class=n>sbert_rerank</span> <span class=o>=</span> <span class=n>SentenceTransformerRerank</span><span class=p>(</span>
    <span class=n>model</span><span class=o>=</span><span class=s2>&quot;cross-encoder/ms-marco-MiniLM-L-2-v2&quot;</span><span class=p>,</span> <span class=n>top_n</span><span class=o>=</span><span class=mi>5</span>
<span class=p>)</span>
<span class=n>retrieved_nodes</span> <span class=o>=</span> <span class=n>sbert_rerank</span><span class=o>.</span><span class=n>postprocess_nodes</span><span class=p>(</span>
    <span class=n>results</span><span class=p>,</span> <span class=n>QueryBundle</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
<span class=p>)</span>
</code></pre></div> <ul> <li><strong>Reranker Configuration</strong>: We set up the <code>SentenceTransformerRerank</code> model. This model is used to rerank the retrieved results for better relevance.</li> <li><strong>Rerank Nodes</strong>: We rerank the retrieved nodes using the <code>SentenceTransformerRerank</code> model and the original query. This ensures that the top results are the most relevant.</li> </ul> <h4 id=step-6-process-retrieved-annotations>Step 6 - Process Retrieved Annotations<a class=headerlink href=#step-6-process-retrieved-annotations title="Permanent link">&para;</a></h4> <p>Now, we determine the Annotation instance ids we retrieved so these can be linked to the datacell. On the OpenContracts frontend, this lets us readily navigate to the Annotations in the source documents:</p> <div class=highlight><pre><span></span><code>        <span class=n>retrieved_annotation_ids</span> <span class=o>=</span> <span class=p>[</span>
            <span class=n>n</span><span class=o>.</span><span class=n>node</span><span class=o>.</span><span class=n>extra_info</span><span class=p>[</span><span class=s2>&quot;annotation_id&quot;</span><span class=p>]</span> <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=n>retrieved_nodes</span>
        <span class=p>]</span>
        <span class=n>datacell</span><span class=o>.</span><span class=n>sources</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=o>*</span><span class=n>retrieved_annotation_ids</span><span class=p>)</span>
</code></pre></div> <ul> <li><strong>Extract Annotation IDs</strong>: We extract the annotation IDs from the retrieved nodes.</li> <li><strong>Add Sources</strong>: We add the retrieved annotation IDs to the <code>sources</code> field of the datacell. This links the relevant annotations to the datacell.</li> </ul> <h4 id=step-7-format-retrieved-text-for-output>Step 7 - Format Retrieved Text for Output<a class=headerlink href=#step-7-format-retrieved-text-for-output title="Permanent link">&para;</a></h4> <p>Next, we aggregate the retrieved annotations into a single string we can pass to an LLM:</p> <div class=highlight><pre><span></span><code>    <span class=n>retrieved_text</span> <span class=o>=</span> <span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
        <span class=p>[</span><span class=sa>f</span><span class=s2>&quot;```Relevant Section:</span><span class=se>\n\n</span><span class=si>{</span><span class=n>n</span><span class=o>.</span><span class=n>text</span><span class=si>}</span><span class=se>\n</span><span class=s2>```&quot;</span> <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=n>results</span><span class=p>]</span>
    <span class=p>)</span>
    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Retrieved text: </span><span class=si>{</span><span class=n>retrieved_text</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <ul> <li><strong>Format Text</strong>: We format the retrieved text for output. Each relevant section is enclosed in Markdown code blocks for better readability.</li> <li><strong>Log Retrieved Text</strong>: We log the retrieved text for debugging and tracking purposes.</li> </ul> <h4 id=step-8-parse-data>Step 8 - Parse Data<a class=headerlink href=#step-8-parse-data title="Permanent link">&para;</a></h4> <p>Finally, we dynamically specify the output schema / format of the data. We use <a href=https://github.com/prefecthq/marvin>marvin</a> to do the structuring, but you could tweak the pipeline to use <a href=https://docs.llamaindex.ai/en/stable/use_cases/extraction/ >LlamaIndex's Structured Data Extract</a> or you could roll your own custom parsers.</p> <div class=highlight><pre><span></span><code>        <span class=n>output_type</span> <span class=o>=</span> <span class=n>parse_model_or_primitive</span><span class=p>(</span><span class=n>datacell</span><span class=o>.</span><span class=n>column</span><span class=o>.</span><span class=n>output_type</span><span class=p>)</span>
        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Output type: </span><span class=si>{</span><span class=n>output_type</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

        <span class=c1># If provided, we use the column parse instructions property to instruct Marvin how to parse, otherwise,</span>
        <span class=c1># we give it the query and target output schema. Usually the latter approach is OK, but the former is more</span>
        <span class=c1># intentional and gives better performance.</span>
        <span class=n>parse_instructions</span> <span class=o>=</span> <span class=n>datacell</span><span class=o>.</span><span class=n>column</span><span class=o>.</span><span class=n>instructions</span>

        <span class=n>result</span> <span class=o>=</span> <span class=n>marvin</span><span class=o>.</span><span class=n>cast</span><span class=p>(</span>
            <span class=n>retrieved_text</span><span class=p>,</span>
            <span class=n>target</span><span class=o>=</span><span class=n>output_type</span><span class=p>,</span>
            <span class=n>instructions</span><span class=o>=</span><span class=n>parse_instructions</span> <span class=k>if</span> <span class=n>parse_instructions</span> <span class=k>else</span> <span class=n>query</span><span class=p>,</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>BaseModel</span><span class=p>):</span>
            <span class=n>datacell</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;data&quot;</span><span class=p>:</span> <span class=n>result</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()}</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>datacell</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;data&quot;</span><span class=p>:</span> <span class=n>result</span><span class=p>}</span>
        <span class=n>datacell</span><span class=o>.</span><span class=n>completed</span> <span class=o>=</span> <span class=n>timezone</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
        <span class=n>datacell</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</code></pre></div> <ul> <li><strong>Determine Output Type</strong>: We determine the output type based on the column's output type.</li> <li><strong>Log Output Type</strong>: We log the output type for debugging purposes.</li> <li><strong>Parse Instructions</strong>: We fetch parsing instructions from the column.</li> <li><strong>Parse Result</strong>: We use <code>marvin.cast</code> to parse the retrieved text into the desired output type using the parsing instructions.</li> <li><strong>Save Result</strong>: We save the parsed result in the <code>data</code> field of the datacell. We also mark the datacell as completed and save the changes to the database.</li> </ul> <h4 id=step-9-save-results>Step 9 - Save Results<a class=headerlink href=#step-9-save-results title="Permanent link">&para;</a></h4> <p>This step is particularly important if you write your own extract. We're planning to write a decorator to make a lot of this easier and automatic, but, for now, you need to remember to store the output of your extract task as a json of form</p> <div class=highlight><pre><span></span><code><span class=p>{</span>
<span class=w>  </span><span class=nt>&quot;data&quot;</span><span class=p>:</span><span class=w> </span><span class=err>&lt;ex</span><span class=kc>tra</span><span class=err>c</span><span class=kc>te</span><span class=err>d</span><span class=w> </span><span class=err>da</span><span class=kc>ta</span><span class=err>&gt;</span>
<span class=p>}</span>
</code></pre></div> <p>Here's the code from <code>oc_llama_index_doc_query</code>:</p> <div class=highlight><pre><span></span><code> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>BaseModel</span><span class=p>):</span>
    <span class=n>datacell</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;data&quot;</span><span class=p>:</span> <span class=n>result</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()}</span>
<span class=k>else</span><span class=p>:</span>
    <span class=n>datacell</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;data&quot;</span><span class=p>:</span> <span class=n>result</span><span class=p>}</span>

<span class=n>datacell</span><span class=o>.</span><span class=n>completed</span> <span class=o>=</span> <span class=n>timezone</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
<span class=n>datacell</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</code></pre></div> <h4 id=step-10-exception-handling>Step 10 - Exception Handling<a class=headerlink href=#step-10-exception-handling title="Permanent link">&para;</a></h4> <p>If processign fails, we catch the error and stacktrace. These are store with the Datacell so we can see which extracts succeded or failed, and, if they failed, why.</p> <div class=highlight><pre><span></span><code>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;run_extract() - Ran into error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
        <span class=n>datacell</span><span class=o>.</span><span class=n>stacktrace</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;Error processing: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span>
        <span class=n>datacell</span><span class=o>.</span><span class=n>failed</span> <span class=o>=</span> <span class=n>timezone</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
        <span class=n>datacell</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</code></pre></div> <ul> <li><strong>Exception Logging</strong>: We log any exceptions that occur during the processing.</li> <li><strong>Save Stacktrace</strong>: We save the error message in the <code>stacktrace</code> field of the datacell.</li> <li><strong>Mark as Failed</strong>: We mark the datacell as failed and save the changes to the database.</li> </ul> <h2 id=write-a-custom-llamaindex-extractor>Write a Custom LlamaIndex Extractor<a class=headerlink href=#write-a-custom-llamaindex-extractor title="Permanent link">&para;</a></h2> <p>Let's write another data extractor based on LlamaIndex's REACT Agent!</p> <h3 id=step-1-ensure-you-load-datacell>Step 1 - Ensure you Load Datacell<a class=headerlink href=#step-1-ensure-you-load-datacell title="Permanent link">&para;</a></h3> <p>As mentioned above, we'd like to use decorators to make some of this more automatic, but, for now, you need to load the Datacell instance from the provided id:</p> <div class=highlight><pre><span></span><code><span class=nd>@shared_task</span>
<span class=k>def</span> <span class=nf>llama_index_react_agent_query</span><span class=p>(</span><span class=n>cell_id</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Use our DjangoAnnotationVectorStore + LlamaIndex REACT Agent to retrieve text.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>datacell</span> <span class=o>=</span> <span class=n>Datacell</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>cell_id</span><span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>

        <span class=n>datacell</span><span class=o>.</span><span class=n>started</span> <span class=o>=</span> <span class=n>timezone</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
        <span class=n>datacell</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</code></pre></div> <h3 id=step-2-setup-embeddings-model-llm>Step 2 - Setup Embeddings Model + LLM<a class=headerlink href=#step-2-setup-embeddings-model-llm title="Permanent link">&para;</a></h3> <p>OpenContracts uses <code>multi-qa-MiniLM-L6-cos-v1</code> to generate its embeddings (for now, we can make this modular as well). You can use whatever LLM you want, but we're using GPT-4o. Don't forget to isntantiate both of these and configure LlamaIndex's global settings:</p> <div class=highlight><pre><span></span><code><span class=n>embed_model</span> <span class=o>=</span> <span class=n>HuggingFaceEmbedding</span><span class=p>(</span>
    <span class=n>model_name</span><span class=o>=</span><span class=s2>&quot;multi-qa-MiniLM-L6-cos-v1&quot;</span><span class=p>,</span> <span class=n>cache_folder</span><span class=o>=</span><span class=s2>&quot;/models&quot;</span>
<span class=p>)</span>  <span class=c1># Using our pre-load cache path where the model was stored on container build</span>
<span class=n>Settings</span><span class=o>.</span><span class=n>embed_model</span> <span class=o>=</span> <span class=n>embed_model</span>

<span class=n>llm</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>settings</span><span class=o>.</span><span class=n>OPENAI_MODEL</span><span class=p>,</span> <span class=n>api_key</span><span class=o>=</span><span class=n>settings</span><span class=o>.</span><span class=n>OPENAI_API_KEY</span><span class=p>)</span>
<span class=n>Settings</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</code></pre></div> <h3 id=step-3-instantiate-open-contracts-vector-store>Step 3 - Instantiate Open Contracts Vector Store<a class=headerlink href=#step-3-instantiate-open-contracts-vector-store title="Permanent link">&para;</a></h3> <p>Now, let's instantiate a vector store that will only retrieve annotations from the document linked to our loaded datacell:</p> <div class=highlight><pre><span></span><code><span class=n>document</span> <span class=o>=</span> <span class=n>datacell</span><span class=o>.</span><span class=n>document</span>

 <span class=n>vector_store</span> <span class=o>=</span> <span class=n>DjangoAnnotationVectorStore</span><span class=o>.</span><span class=n>from_params</span><span class=p>(</span>
    <span class=n>document_id</span><span class=o>=</span><span class=n>document</span><span class=o>.</span><span class=n>id</span><span class=p>,</span> <span class=n>must_have_text</span><span class=o>=</span><span class=n>datacell</span><span class=o>.</span><span class=n>column</span><span class=o>.</span><span class=n>must_contain_text</span>
<span class=p>)</span>
<span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_vector_store</span><span class=p>(</span><span class=n>vector_store</span><span class=o>=</span><span class=n>vector_store</span><span class=p>)</span>
</code></pre></div> <h3 id=step-4-instantiate-query-engine-wrap-it-as-llm-agent-tool>Step 4 - Instantiate Query Engine &amp; Wrap it As LLM Agent Tool<a class=headerlink href=#step-4-instantiate-query-engine-wrap-it-as-llm-agent-tool title="Permanent link">&para;</a></h3> <p>Next, let's use OpenContracts as a LlamaIndex query engine:</p> <div class=highlight><pre><span></span><code><span class=n>doc_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>(</span><span class=n>similarity_top_k</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</code></pre></div> <p>And let's use that engine with an agent tool:</p> <div class=highlight><pre><span></span><code><span class=n>document</span> <span class=o>=</span> <span class=n>datacell</span><span class=o>.</span><span class=n>document</span>

<span class=n>query_engine_tools</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>QueryEngineTool</span><span class=p>(</span>
        <span class=n>query_engine</span><span class=o>=</span><span class=n>doc_engine</span><span class=p>,</span>
        <span class=n>metadata</span><span class=o>=</span><span class=n>ToolMetadata</span><span class=p>(</span>
            <span class=n>name</span><span class=o>=</span><span class=s2>&quot;doc_engine&quot;</span><span class=p>,</span>
            <span class=n>description</span><span class=o>=</span><span class=p>(</span>
                <span class=sa>f</span><span class=s2>&quot;Provides detailed annotations and text from within the </span><span class=si>{</span><span class=n>document</span><span class=o>.</span><span class=n>title</span><span class=si>}</span><span class=s2>&quot;</span>
            <span class=p>),</span>
        <span class=p>),</span>
    <span class=p>)</span>
<span class=p>]</span>
</code></pre></div> <h3 id=step-5-setup-agent>Step 5 - Setup Agent<a class=headerlink href=#step-5-setup-agent title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=n>agent</span> <span class=o>=</span> <span class=n>ReActAgent</span><span class=o>.</span><span class=n>from_tools</span><span class=p>(</span>
    <span class=n>query_engine_tools</span><span class=p>,</span>
    <span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span>
    <span class=n>verbose</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
    <span class=c1># context=context</span>
<span class=p>)</span>
</code></pre></div> <h3 id=step-6-decide-how-to-map-column-properties-to-retrieval-process>Step 6 - Decide how to Map Column Properties to Retrieval Process<a class=headerlink href=#step-6-decide-how-to-map-column-properties-to-retrieval-process title="Permanent link">&para;</a></h3> <p>As discussed above, the <code>Column</code> model definition has a lot of properties that service slightly different purposes depending on your RAG implementation. Since we're writing a new extract, you can decide how to map these inputs here. To keep things simple for starters, let's just take the column's query and pass it directly to the React Agent. For improvements, we could have a more complex prompt to apps along, for example, parsing instructions.</p> <div class=highlight><pre><span></span><code><span class=n>response</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=s2>&quot;What was Lyft&#39;s revenue growth in 2021?&quot;</span><span class=p>)</span>
</code></pre></div> <h3 id=step-7-post-process-and-store-data>Step 7 - Post-Process and Store Data<a class=headerlink href=#step-7-post-process-and-store-data title="Permanent link">&para;</a></h3> <p>At this stage we <em>could</em> use a structured data parser, or we could just store the answer from the agent. For simplicity, let's do the latter:</p> <div class=highlight><pre><span></span><code><span class=n>datacell</span><span class=o>.</span><span class=n>data</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;data&quot;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>response</span><span class=p>)}</span>
<span class=n>datacell</span><span class=o>.</span><span class=n>completed</span> <span class=o>=</span> <span class=n>timezone</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
<span class=n>datacell</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</code></pre></div> <h3 id=step-8-rebuild-containers-and-look-at-your-frontend>Step 8 - Rebuild Containers and Look at Your Frontend<a class=headerlink href=#step-8-rebuild-containers-and-look-at-your-frontend title="Permanent link">&para;</a></h3> <p>The next time you rebuild the containers (in prod, in local env they rebuild automatically), you will see a new entry in the column configuration modals:</p> <p><a class=glightbox href=../../../docs/assets/images/screenshots/Custom_Extract_Task.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=Custom_Extract_Task.png src=../../../docs/assets/images/screenshots/Custom_Extract_Task.png></a></p> <p>It's that easy! Now, any user in your instance can run your extract and generate outputs - here we've used it for the Company Name column:</p> <p><a class=glightbox href=../../../docs/assets/images/screenshots/Agent_Extract_Demo_Run.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=Agent_Extract_Demo_Run.png src=../../../docs/assets/images/screenshots/Agent_Extract_Demo_Run.png></a></p> <p>We plan to create decorators and other developer aids to reduce boilerplate here and let you focus entirely on your retrieval pipeline.</p> <h3 id=conclusion>Conclusion<a class=headerlink href=#conclusion title="Permanent link">&para;</a></h3> <p>By breaking down the tasks step-by-step, you can see how the custom vector store integrates with LlamaIndex to provide powerful semantic search capabilities within a Django application. Even better, if you write your own data extract tasks you can expose them to users who don't have to know anything at all about how they're built. This is the way it should be - separation of concerns!</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">June 23, 2024</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; John Scrudato 2022-present </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/ofek target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> <a href=https://ofek.dev/words/ target=_blank rel=noopener title=ofek.dev class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M192 32c0 17.7 14.3 32 32 32 123.7 0 224 100.3 224 224 0 17.7 14.3 32 32 32s32-14.3 32-32C512 128.9 383.1 0 224 0c-17.7 0-32 14.3-32 32zm0 96c0 17.7 14.3 32 32 32 70.7 0 128 57.3 128 128 0 17.7 14.3 32 32 32s32-14.3 32-32c0-106-86-192-192-192-17.7 0-32 14.3-32 32zm-96 16c0-26.5-21.5-48-48-48S0 117.5 0 144v224c0 79.5 64.5 144 144 144s144-64.5 144-144-64.5-144-144-144h-16v96h16c26.5 0 48 21.5 48 48s-21.5 48-48 48-48-21.5-48-48V144z"/></svg> </a> <a href=https://twitter.com/Ofekmeister target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://www.linkedin.com/in/ofeklev/ target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.sections", "navigation.expand", "navigation.tabs", "navigation.tabs.sticky", "navigation.instant"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script> <script src=../../../assets/javascripts/bundle.ad660dcc.min.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>